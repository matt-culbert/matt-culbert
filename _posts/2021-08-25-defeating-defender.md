---
layout: post
title: Defeating Defender
date: '2021-08-25T16:43:00.004-07:00'
author: Matt C
tags: 
modified_time: '2021-08-26T09:38:26.761-07:00'
thumbnail: https://1.bp.blogspot.com/-sbKsQwRfqRg/YSba1y4IdpI/AAAAAAAAHrA/b4-WFpv7d1EpQ2ujvOgQCoH8s5C8OuvmwCLcBGAsYHQ/s72-c/ransomwareImproved.png
blogger_id: tag:blogger.com,1999:blog-8951407132095927802.post-8846999407528774392
blogger_orig_url: https://cr.culbertreport.com/2021/08/defeating-defender.html
---

<p>&nbsp;<span>&nbsp;&nbsp; &nbsp;</span>So far Defender has being the reigning champion for AV detection rates. Up there with McAfee somehow. Well, today Defender comes toppling down<strike> leaving McAfee at the top of the list</strike> <span style="color: red;">UPDATE</span>: McAfee is actually worse than Defender. While they pick up these samples on VirusTotal, their home product does not detect these ransomware samples and they do not prevent files in the users folder from having their contents encrypted, which Defender does do. <strike>I can honestly say I did not see that coming when I set out to test detection rates of AV programs.</strike>&nbsp;</p><p><span>&nbsp;&nbsp;&nbsp; </span>Looking back to one of our first applications, we used a simple Python program to encrypt all the files in a folder:</p><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-sbKsQwRfqRg/YSba1y4IdpI/AAAAAAAAHrA/b4-WFpv7d1EpQ2ujvOgQCoH8s5C8OuvmwCLcBGAsYHQ/s449/ransomwareImproved.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="381" data-original-width="449" height="272" src="https://1.bp.blogspot.com/-sbKsQwRfqRg/YSba1y4IdpI/AAAAAAAAHrA/b4-WFpv7d1EpQ2ujvOgQCoH8s5C8OuvmwCLcBGAsYHQ/s320/ransomwareImproved.png" width="320" /></a></div><br /><p></p><span>&nbsp;&nbsp;&nbsp; </span>As noted at the time though, this was and still is caught immediately by Defender and removed:<div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-v9Dc-m2KoXA/YSbO7RWQbgI/AAAAAAAAHqo/rHhWpWHJMw4Ko62E0fJInldb4spqFWl5QCLcBGAsYHQ/s1309/catch_rate.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="1230" data-original-width="1309" height="301" src="https://1.bp.blogspot.com/-v9Dc-m2KoXA/YSbO7RWQbgI/AAAAAAAAHqo/rHhWpWHJMw4Ko62E0fJInldb4spqFWl5QCLcBGAsYHQ/s320/catch_rate.png" width="320" /></a></div><br /><p></p><p>&nbsp;So what can we do to defeat this? There are a couple methods freely available online, PyArmor and something called development-tools.net which spits out code that looks like this:</p><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-1Ti-0PT0Iss/YSbNZJwm1MI/AAAAAAAAHqQ/vuCLnavvfqYE6uV9kMhubvWDIrbmjwpBwCLcBGAsYHQ/s2010/wtf_dev_tools.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="180" data-original-width="2010" height="54" src="https://1.bp.blogspot.com/-1Ti-0PT0Iss/YSbNZJwm1MI/AAAAAAAAHqQ/vuCLnavvfqYE6uV9kMhubvWDIrbmjwpBwCLcBGAsYHQ/w598-h54/wtf_dev_tools.png" width="598" /></a></div><span>&nbsp;&nbsp; &nbsp;</span><p></p><p><span>&nbsp;&nbsp;&nbsp; </span>This cleverly uses eval() to execute a series of base64 encoded functions, but unfortunately this is still caught. PyArmor returns very obfuscated code, but it is also immediately detected and removed. So what can we do that these programs can't? Well we actually only need to change very little. Below is my updated code that is fully undetected to Defender. It was able to run and encrypt the contents of a folder in my test area, C:/Test:<br /></p><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-_R8gfG6l13E/YSbN7xborvI/AAAAAAAAHqY/pBhtRnNHpts9GRPXZ3KoYEkcGwkZHmThQCLcBGAsYHQ/s620/defeating_defender.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="370" data-original-width="620" height="191" src="https://1.bp.blogspot.com/-_R8gfG6l13E/YSbN7xborvI/AAAAAAAAHqY/pBhtRnNHpts9GRPXZ3KoYEkcGwkZHmThQCLcBGAsYHQ/s320/defeating_defender.png" width="320" />&nbsp;</a></div><div class="separator" style="clear: both; text-align: left;"><span>&nbsp;&nbsp;&nbsp; </span>So what did we actually change? We made almost all the variables some form of 'bleh' and encoded all the paths in base64. Due to the base64 encoding there was one additional change, we had to change the '\' in the file paths to a '/' because of some weird formatting that occurred after decoding that would make file paths look like 'C:\\\\Test\n\r\'. Like I said though, we didn't have to change much to make this work and be undetected. Below is our detection rate on VirusTotal, again with the only well known brand being McAfee that picks this up.</div><div class="separator" style="clear: both; text-align: left;">&nbsp;</div><div class="separator" style="clear: both; text-align: left;"><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-Xz9nOs9M9vo/YSbN75h8KoI/AAAAAAAAHqc/PaykMei6jC879ffJkV1XmXkp_coiD82dgCLcBGAsYHQ/s1259/vt_detections.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="1227" data-original-width="1259" height="312" src="https://1.bp.blogspot.com/-Xz9nOs9M9vo/YSbN75h8KoI/AAAAAAAAHqc/PaykMei6jC879ffJkV1XmXkp_coiD82dgCLcBGAsYHQ/s320/vt_detections.png" width="320" /></a></div></div><div class="separator" style="clear: both; text-align: left;"><br /></div><div class="separator" style="clear: both; text-align: left;"><span>&nbsp;&nbsp; &nbsp;</span>When I scanned this on the test VM even after running, Defender didn't flag it and nor did it offer ransomware protection rollback for the file affected.&nbsp;</div><div class="separator" style="clear: both; text-align: left;">&nbsp;</div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-iQXCelrytaQ/YSbUH2znXkI/AAAAAAAAHqw/bTybJernG8UiUo6dQ_AGjCu8Yo7bzxLtACLcBGAsYHQ/s944/defender_miss2.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="434" data-original-width="944" height="147" src="https://1.bp.blogspot.com/-iQXCelrytaQ/YSbUH2znXkI/AAAAAAAAHqw/bTybJernG8UiUo6dQ_AGjCu8Yo7bzxLtACLcBGAsYHQ/s320/defender_miss2.png" width="320" />&nbsp;</a></div><div class="separator" style="clear: both; text-align: center;">&nbsp;</div><p><span>&nbsp;&nbsp;&nbsp; Fortunately, the ransomware protection included with Defender does protect the Users folder, among others, from having data over written through this method, which is what we want to see. <strike>Next in line for testing will have to be McAfee, which I cannot stress enough I never thought would be the case. </strike>This is unnecessary. A quick review of McAfee's product shows their protection is far worse for home users than Defender.</span></p><p><span></span></p><div class="separator" style="clear: both; text-align: center;"><span><a href="https://1.bp.blogspot.com/-_fuYXJm7Uxo/YSfDcEeIXtI/AAAAAAAAHrM/HyTE_yB6ve0Yq0BpKs8MkdeAraMWir7eACLcBGAsYHQ/s968/mcafee_fail.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="417" data-original-width="968" height="138" src="https://1.bp.blogspot.com/-_fuYXJm7Uxo/YSfDcEeIXtI/AAAAAAAAHrM/HyTE_yB6ve0Yq0BpKs8MkdeAraMWir7eACLcBGAsYHQ/s320/mcafee_fail.png" width="320" /></a></span></div><span><br />&nbsp;</span><br /><p></p><div class="separator" style="clear: both; text-align: left;">&nbsp;<br /></div><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"></div><p></p>