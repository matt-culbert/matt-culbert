---
layout: post
title: 'Designing Stable C2 Architecture '
date: '2018-08-03T05:28:00.001-07:00'
author: Matt C
tags: 
modified_time: '2018-11-16T06:46:04.170-08:00'
thumbnail: https://3.bp.blogspot.com/-m76cmwAuoFo/W2RMJMDrmVI/AAAAAAAAAJk/vh0B1L80dC0T2nX2SIk_nAnL8N3o-vd9gCLcBGAs/s72-c/apt.jpg
blogger_id: tag:blogger.com,1999:blog-8951407132095927802.post-8980337455002280059
blogger_orig_url: https://cr.culbertreport.com/2018/08/designing-stable-c2-architecture.html
---

<a href="about:invalid#zClosurez" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"></a><br /><a href="https://3.bp.blogspot.com/-m76cmwAuoFo/W2RMJMDrmVI/AAAAAAAAAJk/vh0B1L80dC0T2nX2SIk_nAnL8N3o-vd9gCLcBGAs/s1600/apt.jpg" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" data-original-height="250" data-original-width="306" src="https://3.bp.blogspot.com/-m76cmwAuoFo/W2RMJMDrmVI/AAAAAAAAAJk/vh0B1L80dC0T2nX2SIk_nAnL8N3o-vd9gCLcBGAs/s1600/apt.jpg" /></a><br />C2 Architecture is one of the most important aspects of the APT world.<br /><br />Proper C2 architecture lets you subvert IDS, antivirus, and network analysts.<br /><br />It lets you exfiltrate data. It lets you move laterally across networks while raising minimal flags.<br /><br />How do you do this properly?<br /><br />Too much data going out one point, and it raises flags. Too much data moving between nodes that don't normally have connections to each other, alarms raised. Too much user account activity on nodes that don't normally have that - Alarms. Raised.<br /><br />Modern SIEMs make it very difficult to create abnormal data traffic thanks to anomaly detection and heuristic analysis.<br /><br />These systems are not perfect though, and the false sense of security they provide can actually be a pen testers advantage. Since people treat these systems as infallible, they rely heavily on the data provided and without them the analysts are nothing.<br /><br />You have a few routes to get around this. You can masquerade your traffic as normal SMB traffic around the network, or even better, masquerade it as router traffic like RIP or OSPF. IDS systems are very careful not to intercept or mess with router communication.<br /><br />Getting traffic out of the network is even harder. While it will be easier than initiating a connection from the outside in, since these will be blocked outright, it still raises a lot of flags watching a lot of different systems all of a sudden communicating with one server. I know from personal experience that a lot of data being transferred to outside the network will raise alarms. What you are looking for is to route traffic through one of the compromised nodes and out from there to the first stage of the C2 systems. Seeing multiple nodes communicating out to one cloud device will raise alarms. Seeing one node, specifically one that already does out of network communications, will raise less flags.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-omYUjAMUV2Q/W6UFYXV1s5I/AAAAAAAAALE/BG_mAdwfps0poaC1FY-TDCkNUG_7tNuNACLcBGAs/s1600/2018-09-21%2B10_49_23-Drawing1%2B-%2BVisio%2BStandard.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em; text-align: left;"><img border="0" data-original-height="450" data-original-width="511" height="351" src="https://3.bp.blogspot.com/-omYUjAMUV2Q/W6UFYXV1s5I/AAAAAAAAALE/BG_mAdwfps0poaC1FY-TDCkNUG_7tNuNACLcBGAs/s400/2018-09-21%2B10_49_23-Drawing1%2B-%2BVisio%2BStandard.png" width="400" /></a></div><br />Creates a lot less traffic than:<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://4.bp.blogspot.com/-rwXoBWm7ifs/W2RfpEoaEFI/AAAAAAAAAJ8/jP798cXafRAGj9283j6XGtOW2xijjfEzACLcBGAs/s1600/c3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="580" data-original-width="490" src="https://4.bp.blogspot.com/-rwXoBWm7ifs/W2RfpEoaEFI/AAAAAAAAAJ8/jP798cXafRAGj9283j6XGtOW2xijjfEzACLcBGAs/s1600/c3.png" /></a></div><br />These are inherent flaws in how logs are collected. If a device that normally does a lot of out of network communication is put on an IDS, it will generate a lot of alarms. These will be, over time, tuned out due to the amount of volume they create. Taking Target as an example. A flood of small alarms will hide more important ones, which can lead to systems being compromised if their alarms are not dealt with fast enough. A smart pen tester will abuse this tuning to try and find a high threshold of outbound traffic which doesn't trigger alarms. Smarter IDS will use machine learning and AI to take some of the manual work out of these alarms, but smaller operations generally can not afford these systems as of yet.<br /><br />It's important to masquerade traffic leaving the system as something encrypted but simultaneously innocuous. Something to consider is DNS TXT records. You can host a server on a cloud compute platform that is set to respond to DNS requests. These TXT records can contain any variety of commands for your slaves to receive and generally IDS systems will not alarm on these. This makes it fairly easy to abuse. One thing to note is that the IDS might read the contents of the TXT response. I suggest XORng the commands or using some other kind of obfuscation so as to make it harder to determine what is in the responses to non authenticated eyes.<br /><br />One more step is to create an election process within the compromised nodes, so that when one master goes down, another one is elected. Simplicity is better. The sky's the limits with what factors can go into this, but don't make it more complicated than it needs to be. Something like sending out probes to each node neighbors then seeing who gets the highest probe count would be adequate for considering who becomes the master node and who then gets to route traffic out to the C2 server.