---
layout: post
title: Examining Python Malware And AV Detection
date: '2021-07-21T15:17:00.007-07:00'
author: Matt C
tags: 
modified_time: '2021-07-24T12:51:32.871-07:00'
thumbnail: https://1.bp.blogspot.com/-r_ermvA8NLE/YPiT5URDkLI/AAAAAAAAHoM/yuuT5yb_6Xw4vvYAlqBfKmUBgs_tBapuwCLcBGAsYHQ/s72-c/python_encryptor.png
blogger_id: tag:blogger.com,1999:blog-8951407132095927802.post-7720760197433766830
blogger_orig_url: https://cr.culbertreport.com/2021/07/examining-python-malware.html
---

<span></span><h2 style="text-align: left;">What does Python malware look like?</h2><h3 style="text-align: left;">It comes in many flavors</h3><p style="text-align: left;">Python malware has recently taken off because of its ease of development and deployment. Due to it's simple nature, it's easy to do many different things. The example below is what could be considered ransomware, it targets an arbitrary folder and turns it into an encrypted zip. It also leaves the old folder behind but real ransomware won't do this. <br /></p><p></p><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-r_ermvA8NLE/YPiT5URDkLI/AAAAAAAAHoM/yuuT5yb_6Xw4vvYAlqBfKmUBgs_tBapuwCLcBGAsYHQ/s915/python_encryptor.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="746" data-original-width="915" src="https://1.bp.blogspot.com/-r_ermvA8NLE/YPiT5URDkLI/AAAAAAAAHoM/yuuT5yb_6Xw4vvYAlqBfKmUBgs_tBapuwCLcBGAsYHQ/s320/python_encryptor.png" width="320" /></a></div>When we turn the Python PE file into Python byte code using pyinstxtractor.py then examine that byte code with uncompyle6, we can see a few different instructions off the bat that should indicate this could be ransomware. Things like AES, encryption, zipping files, and setting a password all should raise flags in modern AV.<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-3BTkoq4nIlk/YPiQlliWxTI/AAAAAAAAHn8/rqYJCAAZWlgqU93VqMFGd7mOBKO6LpjZACLcBGAsYHQ/s954/python-malware_examined.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="954" data-original-width="841" height="320" src="https://1.bp.blogspot.com/-3BTkoq4nIlk/YPiQlliWxTI/AAAAAAAAHn8/rqYJCAAZWlgqU93VqMFGd7mOBKO6LpjZACLcBGAsYHQ/s320/python-malware_examined.png" /></a></div><h2 style="text-align: left;">What does detection for this look like?<br /></h2><p>But, as illustrated below, this file isn't flagged for detection by a majority of AV. Defender correctly categorizes this as a Win32/Wacapew.C!ml which indicates that this program might block access to a users folder.<br /></p><p></p><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-FLt1fGbxAjs/YPiXABVNZWI/AAAAAAAAHoU/ZRCDrDhGveM0q3lLZquQD_GZ1FBnpxFDwCLcBGAsYHQ/s1261/encryptor-detection.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="1244" data-original-width="1261" src="https://1.bp.blogspot.com/-FLt1fGbxAjs/YPiXABVNZWI/AAAAAAAAHoU/ZRCDrDhGveM0q3lLZquQD_GZ1FBnpxFDwCLcBGAsYHQ/s320/encryptor-detection.png" width="320" /></a></div><p>&nbsp;</p><p>So why hasn't a lot modern AV caught up with this? Evidently AV like Sophos can spot Python malware, as indicated by <a href="https://www.virustotal.com/gui/file/3eb86b7b067c296ef53e4857a74e09f12c2b84b666fc130d1f58aec18bc74b0d/detection">this VirusTotal</a> sample for SeaDuke, so is their threshold just too low? When downloading this on a Defender protected system using Brave, i.e. not using a Defender protected browser, Defender still performs a code analysis on the file and correctly identifies it as malicious.</p><p></p><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-NpdOR057IeU/YPq_dBQyp4I/AAAAAAAAHog/2uLcQAeRzYkNzivUiEjRwJsCZmyUpg-rQCLcBGAsYHQ/s497/defender_active_blocking.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="497" data-original-width="490" height="320" src="https://1.bp.blogspot.com/-NpdOR057IeU/YPq_dBQyp4I/AAAAAAAAHog/2uLcQAeRzYkNzivUiEjRwJsCZmyUpg-rQCLcBGAsYHQ/s320/defender_active_blocking.png" /></a></div><p><br /> This is something that Sophos business didn't even do or flag, let alone their Home product. Looking at Sophos Home features, they analyze for known threats using signature detection and offer predictive AI threat detection to try and identify new and novel threats in the wild. You have to pay for things like advanced real time protection or <i>ransomware protection</i>, something every vendor should be offering on their <b>base</b> product, and you have to wonder if this is part of the racket of incentivizing people to pay to upgrade to something that'll actually protect you.&nbsp;</p><p>To really emphasize how much Sophos is letting down its user base, I wrote a quick YARA rule based on what I saw in the hex analysis of one of the PE's I had made.</p><p></p><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-ik-i9kGGRJU/YPxvNBS5W6I/AAAAAAAAHo8/pBeMtHj3Q8ksFRgutEdzxvHB68L9ngHMQCLcBGAsYHQ/s598/hex_ioc.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="284" data-original-width="598" src="https://1.bp.blogspot.com/-ik-i9kGGRJU/YPxvNBS5W6I/AAAAAAAAHo8/pBeMtHj3Q8ksFRgutEdzxvHB68L9ngHMQCLcBGAsYHQ/s320/hex_ioc.png" width="320" /></a></div><p></p><p></p><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-14A9onzCDrg/YPxudXlfctI/AAAAAAAAHos/CYCxOK6d1EouPwTxCRYqm_VyRzXrxvXbwCLcBGAsYHQ/s540/yara_rules.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="324" data-original-width="540" src="https://1.bp.blogspot.com/-14A9onzCDrg/YPxudXlfctI/AAAAAAAAHos/CYCxOK6d1EouPwTxCRYqm_VyRzXrxvXbwCLcBGAsYHQ/s320/yara_rules.png" width="320" /></a></div><p></p><p>Utilizing that YARA rule is a Python script to analyze a PE file in my downloads, detect if it is a Python PE file based off what is in the compiled binary, then convert it to Python byte code and analyze that for elements that'd indicate if it was doing something malicious.</p><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-GJtvAyL5edc/YPxudiJNZEI/AAAAAAAAHow/_YF9z7Je7dEyfrX1PPtOlwqgiGGiNwwywCLcBGAsYHQ/s1191/python_file_analysis.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="518" data-original-width="1191" src="https://1.bp.blogspot.com/-GJtvAyL5edc/YPxudiJNZEI/AAAAAAAAHow/_YF9z7Je7dEyfrX1PPtOlwqgiGGiNwwywCLcBGAsYHQ/s320/python_file_analysis.png" width="320" /></a></div><br />I wrote this in a couple hours. And Sophos doesn't seem to want to roll this out to their paying users even.<br /><p><br /></p><p></p><p><br /></p>