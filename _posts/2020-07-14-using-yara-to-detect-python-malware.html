---
layout: post
title: Using YARA To Detect Python Executables
date: '2020-07-14T08:48:00.005-07:00'
author: Matt C
tags: 
modified_time: '2020-07-14T16:03:28.946-07:00'
blogger_id: tag:blogger.com,1999:blog-8951407132095927802.post-2739327106699646099
blogger_orig_url: https://cr.culbertreport.com/2020/07/using-yara-to-detect-python-malware.html
---

<p dir="ltr" id="docs-internal-guid-3ce3df61-7fff-f10f-1029-007bf9c334c3" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #9e9e9e;"><span style="background-color: transparent; font-family: &quot;arial&quot;; font-size: 11pt; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Python malware is on the rise, with many low level criminals switching to it for it's ease of use, low entry level, and many libraries available to choose from. However, the most widely used tools for transforming them into PE files also leave behind common signatures that tell us the file we've downloaded was once a Python script, making detecting potential malware much easier.</span></span></p><span style="color: #9e9e9e;"><br /></span><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #9e9e9e;"><span style="background-color: transparent; font-family: &quot;arial&quot;; font-size: 11pt; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">YARA is a great tool that allows us to write detection scripts with, and allows us to detect Python executable files with a high level of accuracy. Take the below rule, this will trip on meta data left behind by Py2EXE.</span></span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #d52c1f;"><span style="background-color: transparent; font-family: &quot;arial&quot;; font-size: 11pt; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"><br /></span></span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #d52c1f;"><font size="2"><span style="background-color: transparent; font-family: &quot;arial&quot;; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;"><br /></span></font></span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #d52c1f;"><font size="2"><span style="font-family: &quot;courier&quot;;"><span style="background-color: transparent; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">import "pe"</span></span></font></span></p><span style="color: #d52c1f;"><font size="2"><span style="font-family: &quot;courier&quot;;"></span></font></span><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #d52c1f;"><font size="2"><span style="font-family: &quot;courier&quot;;"><span style="background-color: transparent; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">rule py2exe</span></span></font></span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #d52c1f;"><font size="2"><span style="font-family: &quot;courier&quot;;"><span style="background-color: transparent; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">{</span></span></font></span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #d52c1f;"><font size="2"><span style="font-family: &quot;courier&quot;;"><span style="background-color: transparent; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;condition:</span></span></font></span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #d52c1f;"><font size="2"><span style="font-family: &quot;courier&quot;;"><span style="background-color: transparent; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for any i in (0 .. pe.number_of_resources - 1):</span></span></font></span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #d52c1f;"><font size="2"><span style="font-family: &quot;courier&quot;;"><span style="background-color: transparent; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(pe.resources[i].type_string == "P\x00Y\x00T\x00H\x00O\x00N\x00S\x00C\x00R\x00I\x00P\x00T\x00")</span></span></font></span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #d52c1f;"><font size="2"><span style="font-family: &quot;courier&quot;;"><span style="background-color: transparent; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">}</span></span></font></span></p><div><br /></div><div><br /></div><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #9e9e9e;"><span style="background-color: transparent; font-family: &quot;arial&quot;; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">Similarly, we can detect the meta data left behind by PyInstaller.</span></span></p><span style="color: #9e9e9e;"></span><div><br /></div><div><span style="color: #d52c1f;"><br /></span></div><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #d52c1f;"><font size="2"><span style="font-family: &quot;courier&quot;;"><span style="background-color: transparent; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">import "pe"</span></span></font></span></p><span style="color: #d52c1f;"><font size="2"><span style="font-family: &quot;courier&quot;;"></span></font></span><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #d52c1f;"><font size="2"><span style="font-family: &quot;courier&quot;;"><span style="background-color: transparent; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">rule pyinstaller</span></span></font></span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #d52c1f;"><font size="2"><span style="font-family: &quot;courier&quot;;"><span style="background-color: transparent; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">{</span></span></font></span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #d52c1f;"><font size="2"><span style="font-family: &quot;courier&quot;;"><span style="background-color: transparent; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;strings:</span></span></font></span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #d52c1f;"><font size="2"><span style="font-family: &quot;courier&quot;;"><span style="background-color: transparent; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$a = "pyi-windows-manifest-filename"</span></span></font></span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #d52c1f;"><font size="2"><span style="font-family: &quot;courier&quot;;"><span style="background-color: transparent; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;condition:</span></span></font></span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #d52c1f;"><font size="2"><span style="font-family: &quot;courier&quot;;"><span style="background-color: transparent; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pe.number_of_resources &gt; 0 and $a</span></span></font></span></p><p dir="ltr" style="line-height: 1.38; margin-bottom: 0pt; margin-top: 0pt;"><span style="color: #d52c1f;"><font size="2"><span style="font-family: &quot;courier&quot;;"><span style="background-color: transparent; font-style: normal; font-variant: normal; font-weight: 400; text-decoration: none; vertical-align: baseline; white-space: pre-wrap;">}</span></span></font></span></p><span style="color: #9e9e9e;"><br /><br /></span><div><span style="color: #9e9e9e;">YARA can be used to detect far more than just these examples, and as you can see it's very flexible. I encourage you to take what we've reviewed here and try to write your own rules. </span></div><div><span style="color: #9e9e9e;"></span></div>