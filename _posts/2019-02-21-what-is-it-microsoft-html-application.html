---
layout: post
title: MSHTA Files & Exploitations
date: '2019-02-21T11:53:00.001-08:00'
author: Matt C
tags: 
modified_time: '2019-02-21T12:40:11.781-08:00'
blogger_id: tag:blogger.com,1999:blog-8951407132095927802.post-5547693785769031814
blogger_orig_url: https://cr.culbertreport.com/2019/02/what-is-it-microsoft-html-application.html
---

<span style="color: red;"><u>What is it:</u></span><br /><br />Microsoft HTML Application Host and CHM files. The program is located at C:\Windows\SysWOW64<br /><br />An outdated relic on Windows machines used to host help documents.<br /><br />Microsoft has documented that this is no longer supported:<br /><div style="text-align: center;"><blockquote class="tr_bq">The Internet Explorer team is increasingly focused on standards compliance, and markup-based behaviors are not part of modern web standards. In IE10 mode support for markup based behaviors has been removed, and this includes hta:application.</blockquote></div><div style="text-align: center;"><br /></div>Some companies and hardware vendors are still using these file formats to manage their software.<br /><br />FireEye outlines an effective attack exploiting HTA:<br /><ol><li>A threat actor emails a Microsoft Word document to a targeted user with an embedded OLE2 embedded link object</li><li>When the user opens the document, winword.exe issues a HTTP request to a remote server to retrieve a malicious HTA file</li><li>The file returned by the server is a fake RTF file with an embedded malicious script</li><li>Winword.exe looks up the file handler for application/hta through a COM object, which causes the Microsoft HTA application (mshta.exe) to load and execute the malicious script</li></ol><br /><span style="color: red;"><u>How it works:</u></span><br /><span style="color: red;"><u><br /></u></span>The rough outline for how it works can be seen in the last step of the attack outlined above. To go into more detail; the word document makes a request to the DCOMLaunch service which causes the service host process (svchost) hosting the word document to execute the Microsoft HTML Application Host(MSHTA) service which then executes the VBScript embedded in the HTA document (paraphrased from FireEye).<br /><br />There are multiple areas of potential exploit using this method. The two biggest are that these HTA files run as a fully trusted application and that the VBS they can execute also has a high level of inherent trust. This means that these applications will very rarely cause a UAC prompt to pop.<br /><span style="color: red;"><u><br /></u></span><span style="color: red;"><u>Affected Versions:</u></span><br /><span style="color: red;"><u><br /></u></span>Up to&nbsp;Windows 10 Version 1607<br /><span style="color: red;"><u><br /></u></span><span style="color: red;"><u>Mitigation:</u></span><br /><br />Anti-virus and end point protection products like Sophos stop these threats out of the box most of the time. If you don't have an end point solution already in use, then an app locker policy should help quite a bit. See an example one below. We will use the file hash of the file since that should not change as it is no longer under development.<br /><br /><ol><li>In Local Security Policy, expand Application Control Policies -&gt; AppLocker</li><li>Right click Executable Rules -&gt; Create New Rule</li><li>Select Deny and the user or group who it should be denied to</li><li>Since the Path of the file can be changed, select the File Hash option for blocking</li><li>Browse to the file in question, and add it</li><li>Create!</li></ol><br /><br /><br />Documentation:<br />https://www.fireeye.com/blog/threat-research/2017/04/cve-2017-0199-hta-handler.html<br /><br />https://web.archive.org/web/20130925022744/https://connect.microsoft.com/IE/feedback/details/785055/hta-application-tag-does-not-work-in-ie10<br /><br />https://blog.checkpoint.com/2015/05/12/the-microsoft-help-file-chm-may-enslave-you/