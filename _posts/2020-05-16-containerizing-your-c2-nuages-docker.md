---
layout: post
title: 'Containerizing Your C2: Nuages, Docker, & A Dusty Pi'
date: '2020-05-16T11:51:00.006-07:00'
author: Matt C
tags:
- c2
- container
- docker
- nuages
modified_time: '2021-11-04T14:44:33.264-07:00'
thumbnail: https://1.bp.blogspot.com/-tqNzHUGdrJc/XsA4IcTYx6I/AAAAAAAAAYI/KyAN7o5fjTYf8-ITrvShlpHJGooxufdjACLcBGAsYHQ/s72-c/docker_final.png
blogger_id: tag:blogger.com,1999:blog-8951407132095927802.post-6086902885670409389
blogger_orig_url: https://cr.culbertreport.com/2020/05/containerizing-your-c2-nuages-docker.html
---

<div class="separator" style="clear: both; text-align: center;"><span id="goog_1789429346"></span><span id="goog_1789429347"></span></div><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-tqNzHUGdrJc/XsA4IcTYx6I/AAAAAAAAAYI/KyAN7o5fjTYf8-ITrvShlpHJGooxufdjACLcBGAsYHQ/s1600/docker_final.png" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="204" data-original-width="847" height="154" src="https://1.bp.blogspot.com/-tqNzHUGdrJc/XsA4IcTYx6I/AAAAAAAAAYI/KyAN7o5fjTYf8-ITrvShlpHJGooxufdjACLcBGAsYHQ/s640/docker_final.png" width="640" /></a></div><div class="separator" style="clear: both; text-align: center;"></div><h2>Why?</h2><span face="&quot;arial&quot;, &quot;helvetica&quot;, sans-serif" style="font-size: medium;"><span>I wanted a low powered container platform and had a rPi 3b sitting around collecting dust. This project  isn't for any practical reasons, but I wanted to emulate what bigger  companies do, dynamically create C2's as they need for any client  operations. I also figured this would be a good learning experience for Docker. <a href="https://github.com/matt-culbert/Nuages">Files found here.</a></span></span><br /><h2>What software was used?</h2><h3>Platform: </h3><h4><span style="font-size: small;"><span face="&quot;arial&quot;, &quot;helvetica&quot;, sans-serif">Docker</span>:</span></h4><pre style="text-align: left;"><span style="font-size: small;"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">Server:</span></span></pre><pre style="text-align: left;"><span style="font-size: small;"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">&nbsp;Engine:</span></span></pre><pre style="text-align: left;"><span style="font-size: small;"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">&nbsp; Version:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 19.03.8</span></span></pre><pre style="text-align: left;"><span style="font-size: small;"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">&nbsp; API version:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.40 (minimum version 1.12)</span></span></pre><pre style="text-align: left;"><span style="font-size: small;"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">&nbsp; Go version:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; go1.13.8</span></span></pre><pre style="text-align: left;"><span style="font-size: small;"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">&nbsp; Git commit:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; afacb8b7f0</span></span></pre><pre style="text-align: left;"><span style="font-size: small;"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">&nbsp; Built:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Wed Mar 11 22:48:33 2020</span></span></pre><pre style="text-align: left;"><span style="font-size: small;"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">&nbsp; OS/Arch:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; linux/arm64</span></span></pre><pre style="text-align: left;"><span style="font-size: small;"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">&nbsp; Experimental:&nbsp;&nbsp;&nbsp;&nbsp; false</span></span></pre><pre style="text-align: left;"><span style="font-size: small;"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">&nbsp;containerd:</span></span></pre><pre style="text-align: left;"><span style="font-size: small;"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">&nbsp; Version:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1.3.3-0ubuntu2 </span></span></pre><h4><span style="font-size: small;"><span face="&quot;arial&quot;, &quot;helvetica&quot;, sans-serif">Ubuntu</span>:</span></h4><pre style="text-align: left;"><span style="font-size: small;"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">Static hostname: ubuntu</span></span></pre><pre style="text-align: left;"><span style="font-size: small;"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Icon name: computer</span></span></pre><pre style="text-align: left;"><span style="font-size: small;"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Machine ID: 577559a1018f47d3828d7448607a6aa1</span></span></pre><pre style="text-align: left;"><span style="font-size: small;"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Boot ID: b35d8bf81ae246dd9ee52d653b9e11e4</span></span></pre><pre style="text-align: left;"><span style="font-size: small;"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">&nbsp; Operating System: Ubuntu 20.04 LTS</span></span></pre><pre style="text-align: left;"><span style="font-size: small;"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Kernel: Linux 5.4.0-1008-raspi</span></span></pre><pre style="text-align: left;"><span style="font-size: small;"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Architecture: arm64 </span></span></pre><h4><span style="font-size: medium; font-weight: normal;">Containers</span><span style="font-size: medium;">: </span></h4><span style="font-size: medium;">Mongodb:latest<br />Debian Buster</span><br /><h2>How did this come together?</h2><span face="&quot;arial&quot;, &quot;helvetica&quot;, sans-serif">Nuages Dockerfile:</span> <br /><span face="&quot;arial&quot;, &quot;helvetica&quot;, sans-serif"></span><br /><div class="p1" style="font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; text-align: left;"><pre>FROM debian:latest</pre><pre><br />COPY Nuages /</pre><pre><br />WORKDIR /Server/</pre><pre><br />RUN apt-get update -qy;\</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; apt-get install python3 -qy;\</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; apt-get install npm -qy;\</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; npm install;\</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; chmod +x setup.js;\</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node setup.js matt matt mongodb://192.168.10.66:27017;\</pre><pre>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; npm install</pre><pre><br />WORKDIR /Clients/Nuages_Cli/</pre><pre><br />RUN npm install</pre><pre><br />WORKDIR /Server/</pre><pre><br />CMD ["bash", "start.sh"]</pre><br /></div><div class="p1" style="font-family: &quot;menlo&quot;; font-size: 11px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal;"><span class="s1" style="font-variant-ligatures: no-common-ligatures;"><br /></span></div><span style="font-size: medium;"><span style="font-family: inherit;"><span><span><span face="&quot;arial&quot;, &quot;helvetica&quot;, sans-serif"><span>I rewrote a fair amount of the setup.js file from P3nt4s' original Nuages so that it could take parameters being passed from the CLI. It runs through our needed setup that'd be taken care of by the setup.sh script normally. I'm passing the username: matt password: matt and the database string that we will be setting up next. It also sets up the NPM dependencies for us. Find the updated copy of setup.js on my Github. Another area to note, I don't define the user running this container, meaning it's running as root. This can be a problem if the container were to be compromised and something we will fix.</span></span> </span></span><br /><br /><span><span><span face="&quot;arial&quot;, &quot;helvetica&quot;, sans-serif"><span>Build this with:</span></span> </span></span><br /><span style="font-family: courier;"><span><span>docker build -t nuages_template .</span></span></span><br /><br /><span><span><span><span face="&quot;arial&quot;, &quot;helvetica&quot;, sans-serif">I then used Docker to run the Mongodb instance</span></span></span></span><br /><span style="font-family: courier;"><span><span><span face="&quot;arial&quot;, &quot;helvetica&quot;, sans-serif"><span>docker run --rm -d -p 27017:27017 mongo</span>&nbsp;</span></span></span></span><br /><br /><span><span><span face="&quot;arial&quot;, &quot;helvetica&quot;, sans-serif"><span>This downloaded and setup a MongoDB container with port 27017 mapped from the host to it. This also meant that UFW had to know to allow 27017 in. We also have to allow the beacon port in for Nuages, so might as well knock both out in the same go. I didn't hard code the port into the Nuages script as I wanted to be able to change that easily. We'll use port 8080 for now:</span></span></span></span><br /><span><span><span face="&quot;arial&quot;, &quot;helvetica&quot;, sans-serif"><span>sudo ufw allow 27017</span></span></span></span><br /><span><span>sudo ufw allow 8080</span></span><br /><span><span><span face="&quot;arial&quot;, &quot;helvetica&quot;, sans-serif"><span><span>sudo ufw reload </span>&nbsp;</span></span></span></span><br /><br /><span><span><span face="&quot;arial&quot;, &quot;helvetica&quot;, sans-serif"><span>Now that everything on UFW and Mongo is ready to go, let's run our Nuages container:</span></span></span></span></span></span><br /><span style="font-size: small;"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;"><span face="&quot;arial&quot;, &quot;helvetica&quot;, sans-serif"><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">docker run --rm -d -p 8080:8080 nuages_template</span></span></span></span><span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;"><span style="font-size: x-small;">&nbsp;</span></span><span face="&quot;arial&quot;, &quot;helvetica&quot;, sans-serif">&nbsp;</span><br /><br /><span style="font-size: medium;">This should return successfully and have port 8080 mapped from it to the host. You can terminal into it with</span>&nbsp;<span style="font-family: &quot;courier new&quot;, &quot;courier&quot;, monospace;">docker exec -it &lt;containerID&gt; /bin/bash </span><span face="&quot;arial&quot;, &quot;helvetica&quot;, sans-serif" style="font-size: medium;">and get access to the C2 features.</span><br /><h2>Constraints &amp; Lessons learned?</h2><span style="font-size: medium;">64bit architecture versus 32bit. The first images I used for testing this were all 32bit. I didn't think anything of it at the time, but when trying to get my Nuages container to work with my MongoDB instance, the version of Mongo was incorrect and there wasn't another available. I then tried searching for a Docker container that could run Mongo and nothing was showing up. In my first test before moving to my rPi, I was running Debian Buster 64bit and figured that Raspbian is based on Debian so this should carry over fine. I was wrong. The 32bit nature of Raspbian posed a big challenge that I wasn't able to get around, so I swapped to Ubuntu 20.04 ARM64 image.</span>